<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Self-driving car - No libraries</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body data-new-gr-c-s-check-loaded="14.1173.0" data-gr-ext-installed="">
<div id="loading" style="padding: 5px; border-radius: 5px; background-color: rgba(255, 255, 255, 0.7); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: Arial; font-size: 20px;">
    🚙🚙🚙🚙🚙 LOADING
    <span style="transform: scale(-1, 1); display: inline-block">🚙🚙🚙🚙🚙</span>
</div>

<div id="stage">
    <canvas id="carCanvas" width="1088" height="1010"></canvas>
    <div id="inspectionSection"></div>
    <button id="followBtn" title="Follow Car" onclick="followCar()" style="position: absolute; opacity: 1; transition: all 0.5s ease 0s; font-size: 80px; background: none; left: 968px; top: 890px;">
        🧿
    </button>
    <div style="
               position: absolute;
               background-color: rgba(255, 255, 255, 0.5);
               font-size: 12px;
               bottom: 0px;
               left: 0px;
               font-family: Arial;
            ">
        Using data from
        <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a>
    </div>
</div>
<script src="./world.js"></script>
<script src="./grid.js"></script>
<script src="./viewport.js"></script>
<script src="markings/marking.js"></script>
<script src="markings/stop.js"></script>
<script src="markings/start.js"></script>
<script src="markings/crossing.js"></script>
<script src="markings/parking.js"></script>
<script src="markings/light.js"></script>
<script src="markings/target.js"></script>
<script src="markings/yield.js"></script>
<script src="items/tree.js"></script>
<script src="items/building.js"></script>
<script src="items/water.js"></script>
<script src="./utils.js"></script>
<script src="./graph.js"></script>
<script src="./osm.js"></script>
<script src="./point.js"></script>
<script src="./segment.js"></script>
<script src="./polygon.js"></script>
<script src="./envelope.js"></script>
<script src="./nn.js"></script>
<script src="./decisionBoundary.js"></script>
<script src="./multiDecisionBoundary.js"></script>
<script src="./many_targets_small.js"></script>
<script src="./carInfo.js"></script>

<script src="./miniMap.js"></script>
<script src="./network.js"></script>
<script src="./sensor.js"></script>
<script src="./utils(1).js"></script>
<script src="items/road.js"></script>
<script src="./controls.js"></script>
<script src="items/car.js"></script>

<script src="./main.js"></script>

<script defer="">
    loading.style.opacity = 0;
    let followBestCar = true;
    let manual = false;
    const stopForFittness = true;
    let showGrid = false;
    let verticalButtonsWidth = 0;
    const outputColors = ["green", "blue", "red", "#888"];
    const images = generateImages(["🠉", "🠈", "🠊", "🠋", "⬉", "⬆", "⬈", "⏱️", "🛑", "🚦", "🎯", "🚶", "⚠️", "🅿️"]);
    const carColors = ["#06F", "#F44", "#0B0", "#EB0", "magenta", "cyan", "black"];

    const defaultOptions = localStorage.getItem("defaultOptions")
        ? JSON.parse(localStorage.getItem("defaultOptions"))
        : {
            type: "AI", // "KEYS" "DUMMY"
            width: 30,
            height: 50, //height: 90,
            maxSpeed: 3,
            color: "blue", //color:"orange",
            acceleration: 0.2,
            friction: 0.1,
            autoForward: true,
            sensorOptions: {
                rayCount: 2,
                rayLength: 250,
                raySpread: 0.6, //Math.PI / 2, // Math.PI / 2,
                rayOffset: 0, //-Math.PI/2//0//-Math.PI/4//, rayOffset: 0,
            },
            brainOptions: {
                extraInputs: [], //"s"], //"s"], //["s"], //"s"],
                hiddenLayerNodeCounts: [],
                outputs: ["🠉", "🠈", "🠊", "🠋"],
            },
        };
    const rightBarWidth = 500;
    const carCanvas = document.getElementById("carCanvas");
    carCanvas.width = window.innerWidth - rightBarWidth - verticalButtonsWidth;
    carCanvas.height = window.innerHeight;

    followBtn.style.left = carCanvas.width - 120 + "px";
    followBtn.style.top = window.innerHeight - 120 + "px";

    const grid = Grid.load(carCanvas, world, world.grid);

    const viewport = new Viewport(
        carCanvas,
        2,
        world.offset,
        true,
        true,
        0
    );
    const carCtx = carCanvas.getContext("2d");
    const carMarkings = world.markings.filter((m) => m instanceof Start);

    let stopBorders = world.markings
        .filter((m) => m instanceof Stop)
        .map((s) => [s.border.p2, s.border.p1]);

    let yieldCrossingBorders = world.markings
        .filter((m) => m instanceof Yield)
        .map((s) => [s.border.p2, s.border.p1])
        .concat(
            world.markings
                .filter((m) => m instanceof Crossing)
                .map((s) => [
                    [s.borders[0].p1, s.borders[0].p2],
                    [s.borders[1].p1, s.borders[1].p2],
                    [s.borders[0].p2, s.borders[0].p1],
                    [s.borders[1].p2, s.borders[1].p1],
                ])
                .flat()
        );

    let lightBorders = world.markings
        .filter( (m) => m instanceof Light && (m.state == "red" || m.state == "yellow"))
        .map((s) => [s.border.p1, s.border.p2]);

    const targets = world.markings.filter((m) => m instanceof Target);
    const optimizing = localStorage.getItem("optimizing");
    const N = optimizing ? maxCarCount : carMarkings.length;
    const cars = generateCars(N, carMarkings);

    // TODO: implement a better way to fly to the best car
    // viewport.flyTo(bestCar, true);

    generateMiniMap(world);

    let lastLoop = new Date();
    localStorage.removeItem("optimizing");

    giveAllPaths();

    setTimeout(() => {
        stage.style.opacity = 1;
        loading.style.display = "none";
        animate();
    }, 500);


    function followCar() {
        //followBestCar=true;
        // viewport.flyTo(bestCar, true);
    }

</script>


</body>
<grammarly-desktop-integration data-grammarly-shadow-root="true">
    <template shadowrootmode="open">
        <style>
            div.grammarly-desktop-integration {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
                -moz-user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            div.grammarly-desktop-integration:before {
                content: attr(data-content);
            }
        </style>
        <div aria-label="grammarly-integration" role="group" tabindex="-1" class="grammarly-desktop-integration" data-content="{&quot;mode&quot;:&quot;full&quot;,&quot;isActive&quot;:true,&quot;isUserDisabled&quot;:false}"></div>
    </template>
</grammarly-desktop-integration>
</html>